# AI Agent Instructions for LocalStack AWS Proxy Extension

This repo is a LocalStack extension (plugin) that enables a "proxy mode" - proxying requests for certain AWS services (e.g., S3) to the upstream real AWS cloud, while handling the remaining services locally.

You are an AI agent tasked with adding additional functionality or test coverage to this repo.

## General Instructions

* You can assume that the LocalStack container is running locally, with the proxy extension installed and enabled.
* You can assume that test AWS credentials are configured in the shell environment where the AI agent is running.
* Do *not* touch any files outside the working directory (basedir of this file)!
* You can create new files (no need to prompt for confirmation)
* You can make modifications to files (no need to prompt for confirmation)
* You can delete existing files if needed, but only after user confirmation
* You can call different `make` targets (e.g., `make test`) in this repo (no need to prompt for confirmation)
* For each new file created or existing file modified, add a header comment to the file, something like `# Note/disclosure: This file has been (partially or fully) generated by an AI agent.`
* The proxy tests are executed against real AWS and may incur some costs, so rather than executing the entire test suite or entire modules, focus the testing on individual test functions within a module only.
* Never add any `print(..)` statements to the code - use a logger to report any status to the user, if required.
* To format/lint the codebase you can run `make format` and `make lint`.

## Testing

The proxy functionality is covered by integration tests in the `tests/` folder, one file for each different AWS service (e.g., SQS, S3, etc).

To add a test, follow the pattern in the existing tests.
It usually involves creating two boto3 clients, one for the LocalStack connection, and one for the real upstream AWS cloud.
We then run API requests with both clients and assert that the results are identical, thereby ensuring that the proxy functionality is working properly.

To run a single test via `pytest` (say, `test_my_logic` in `test_s3.py`), use the following command:
```
TEST_PATH=tests/test_s3.py::test_my_logic make test
```

When adding new integration tests, consider the following:
* Include a mix of positive and negative assertions (i.e., presence and absence of resources).
* Include a mix of different configuration options, e.g., the `read_only: true` flag can be specified in the proxy service configuration YAML, enabling read-only mode (which should be covered by tests as well).
* Include some tests that cover matching of resource names (the config YAML allows to specify ARN regex patterns), to ensure the proxy is able to selectively forward requests to certain matching AWS resources only.
* Make sure to either use fixtures (preferred), or reliable cleanups for removing the resources; several fixtures for creating AWS resources are available in the `localstack.testing.pytest.fixtures` module
* If a test uses multiple resources with interdependencies (e.g., an SQS queue connected to an SNS topic), then the test needs to ensure that both resource types are proxied (i.e., created in real AWS), to avoid a situation where a resource in AWS is attempting to reference a local resource in LocalStack (using account ID `000000000000` in their ARN).
* When waiting for the creation status of a resource, use the `localstack.utils.sync.retry(..)` utility function, rather than a manual `for` loop.
